<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bird Sound Classification System</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body { 
            font-family: 'Inter', sans-serif; 
            background: #3a70ef;
            color: #e2e8f0;
            line-height: 1.6;
        }

        /* Navigation Bar */
        .navbar {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            padding: 0;
            position: sticky;
            top: 0;
            z-index: 1000;
            border-bottom: 1px solid #334155;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
        }

        .nav-container {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 2rem;
        }

        .nav-brand {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .nav-brand h1 {
            font-size: 1.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .nav-logo {
            font-size: 2rem;
        }

        .nav-links {
            display: flex;
            gap: 2rem;
            list-style: none;
        }

        .nav-links a {
            color: #cbd5e1;
            text-decoration: none;
            font-weight: 500;
            transition: all 0.3s ease;
            padding: 0.5rem 1rem;
            border-radius: 8px;
        }

        .nav-links a:hover {
            color: #3b82f6;
            background: rgba(59, 130, 246, 0.1);
        }

        .nav-links a.active {
            color: #3b82f6;
            background: rgba(59, 130, 246, 0.15);
        }

        /* Container */
        .container { 
            max-width: 1400px; 
            margin: 0 auto; 
            padding: 2rem;
        }

        /* Header */
        .header { 
            text-align: center; 
            margin-bottom: 3rem; 
            padding: 3rem 2rem;
            background: linear-gradient(135deg, #1e3a8a 0%, #7c3aed 100%);
            border-radius: 20px;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.4);
        }

        .header h1 { 
            font-size: 3rem; 
            margin-bottom: 1rem;
            color: #ffffff;
            font-weight: 700;
        }

        .header p { 
            font-size: 1.2rem; 
            color: #cbd5e1;
            font-weight: 400;
        }

        /* Metrics Grid */
        .metrics-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); 
            gap: 1.5rem; 
            margin-bottom: 3rem; 
        }

        .metric-card { 
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            padding: 2rem; 
            border-radius: 16px; 
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
            border: 1px solid #475569;
        }

        .metric-card:hover { 
            transform: translateY(-5px); 
            box-shadow: 0 15px 40px rgba(59, 130, 246, 0.3);
            border-color: #3b82f6;
        }

        .metric-card h3 { 
            color: #94a3b8; 
            font-size: 0.9rem; 
            text-transform: uppercase; 
            letter-spacing: 1px; 
            margin-bottom: 1rem;
            font-weight: 600;
        }

        .metric-card .value { 
            font-size: 2.5rem; 
            font-weight: 700; 
            color: #3b82f6; 
            margin-bottom: 0.5rem; 
        }

        .metric-card .label { 
            color: #94a3b8; 
            font-size: 0.9rem; 
        }

        .metric-card.status-healthy { 
            border-left: 4px solid #10b981; 
        }

        .metric-card.status-healthy .value {
            color: #10b981;
        }

        /* Section */
        .section { 
            background: #1e293b;
            padding: 2.5rem; 
            border-radius: 16px; 
            margin-bottom: 2rem; 
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            border: 1px solid #334155;
        }

        .section h2 { 
            color: #3b82f6; 
            margin-bottom: 1.5rem; 
            font-size: 1.8rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .section > p {
            color: #94a3b8;
            margin-bottom: 1.5rem;
            font-size: 1rem;
        }

        /* Upload Area */
        .upload-area { 
            border: 3px dashed #475569; 
            border-radius: 12px; 
            padding: 3rem; 
            text-align: center; 
            background: #0f172a;
            transition: all 0.3s ease; 
            cursor: pointer; 
        }

        .upload-area:hover { 
            background: #1e293b;
            border-color: #3b82f6; 
        }

        .upload-area.dragover { 
            background: #1e3a8a;
            border-color: #60a5fa; 
            transform: scale(1.02);
        }

        .upload-area h3 {
            color: #e2e8f0;
            font-size: 1.2rem;
            margin-bottom: 0.5rem;
        }

        .upload-area p {
            color: #94a3b8;
        }

        input[type="file"] { display: none; }

        /* Buttons */
        .btn { 
            padding: 1rem 2rem; 
            border: none; 
            border-radius: 10px; 
            font-size: 1rem; 
            font-weight: 600; 
            cursor: pointer; 
            transition: all 0.3s ease; 
            text-transform: uppercase; 
            letter-spacing: 1px; 
            margin: 0.5rem;
            font-family: 'Inter', sans-serif;
        }

        .btn-primary { 
            background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
            color: white; 
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4);
        }

        .btn-primary:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.6); 
        }

        .btn-secondary { 
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white; 
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4);
        }

        .btn-secondary:hover { 
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(16, 185, 129, 0.6);
        }

        .btn-danger { 
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white; 
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.4);
        }

        .btn-danger:hover { 
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(239, 68, 68, 0.6);
        }

        .btn:disabled { 
            background: #475569;
            cursor: not-allowed; 
            box-shadow: none;
        }

        /* Result Box */
        .result-box { 
            background: linear-gradient(135deg, #064e3b 0%, #065f46 100%);
            border: 2px solid #10b981; 
            border-radius: 12px; 
            padding: 2rem; 
            margin-top: 2rem; 
            display: none; 
        }

        .result-box h3 { 
            color: #6ee7b7; 
            margin-bottom: 1.5rem;
            font-size: 1.5rem;
        }

        .result-item { 
            background: #1e293b;
            padding: 1.5rem; 
            margin: 1rem 0; 
            border-radius: 10px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            border: 1px solid #334155;
        }

        .confidence-bar { 
            height: 12px; 
            background: #334155;
            border-radius: 6px; 
            overflow: hidden; 
            flex-grow: 1; 
            margin-left: 1.5rem; 
            max-width: 200px; 
        }

        .confidence-fill { 
            height: 100%; 
            background: linear-gradient(90deg, #10b981, #059669); 
            transition: width 0.5s ease; 
        }

        /* Error Box */
        .error-box { 
            background: linear-gradient(135deg, #7f1d1d 0%, #991b1b 100%);
            border: 2px solid #ef4444; 
            border-radius: 12px; 
            padding: 1.5rem; 
            margin-top: 2rem; 
            color: #fecaca; 
            display: none; 
        }

        /* Progress Bar */
        .progress-bar { 
            width: 100%; 
            height: 35px; 
            background: #334155;
            border-radius: 17px; 
            overflow: hidden; 
            margin-top: 2rem; 
            display: none;
            box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.3);
        }

        .progress-fill { 
            height: 100%; 
            background: linear-gradient(90deg, #3b82f6, #8b5cf6); 
            transition: width 0.3s ease; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            color: white; 
            font-weight: 700;
            font-size: 0.9rem;
        }

        /* Chart Container */
        .chart-container { 
            margin-top: 2rem; 
            height: 400px; 
            position: relative;
            background: #0f172a;
            padding: 1rem;
            border-radius: 12px;
            border: 1px solid #334155;
        }

        /* Loading */
        .loading { 
            display: none; 
            text-align: center; 
            padding: 2rem; 
        }

        .spinner { 
            border: 4px solid #334155;
            border-top: 4px solid #3b82f6; 
            border-radius: 50%; 
            width: 60px; 
            height: 60px; 
            animation: spin 1s linear infinite; 
            margin: 0 auto; 
        }

        @keyframes spin { 
            0% { transform: rotate(0deg); } 
            100% { transform: rotate(360deg); } 
        }

        /* File List */
        .file-list { 
            margin-top: 1.5rem; 
            max-height: 300px; 
            overflow-y: auto;
        }

        .file-list::-webkit-scrollbar {
            width: 8px;
        }

        .file-list::-webkit-scrollbar-track {
            background: #1e293b;
            border-radius: 4px;
        }

        .file-list::-webkit-scrollbar-thumb {
            background: #475569;
            border-radius: 4px;
        }

        .file-list::-webkit-scrollbar-thumb:hover {
            background: #64748b;
        }

        .file-item { 
            background: #0f172a;
            padding: 1rem; 
            margin: 0.5rem 0; 
            border-radius: 8px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            border: 1px solid #334155;
        }

        .file-item .remove-btn { 
            background: #ef4444;
            color: white; 
            border: none; 
            padding: 0.5rem 1rem; 
            border-radius: 6px; 
            cursor: pointer; 
            font-size: 0.85rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .file-item .remove-btn:hover {
            background: #dc2626;
            transform: scale(1.05);
        }

        /* Retrain Status */
        .retrain-status { 
            background: linear-gradient(135deg, #78350f 0%, #92400e 100%);
            border: 2px solid #f59e0b; 
            border-radius: 12px; 
            padding: 2rem; 
            margin-top: 2rem; 
            display: none; 
        }

        .retrain-status h3 {
            color: #fde68a;
        }

        /* Info Box */
        .info-box { 
            background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%);
            border-left: 4px solid #3b82f6; 
            padding: 1.5rem; 
            margin: 1.5rem 0; 
            border-radius: 8px; 
        }

        .info-box h4 { 
            color: #93c5fd; 
            margin-bottom: 0.8rem;
            font-size: 1.1rem;
        }

        .info-box p { 
            color: #cbd5e1; 
            line-height: 1.8;
            font-size: 0.95rem;
        }

        .info-box code {
            background: #0f172a;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            color: #60a5fa;
            font-family: 'Courier New', monospace;
        }

        /* Visualization Grid */
        .visualization-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(450px, 1fr)); 
            gap: 2rem; 
            margin-top: 2rem; 
        }

        /* Footer */
        .footer {
            text-align: center;
            padding: 2rem;
            margin-top: 3rem;
            color: #64748b;
            border-top: 1px solid #334155;
        }

        .footer p {
            margin-bottom: 0.5rem;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .nav-links {
                display: none;
            }

            .header h1 {
                font-size: 2rem;
            }

            .metrics-grid {
                grid-template-columns: 1fr;
            }

            .visualization-grid {
                grid-template-columns: 1fr;
            }

            .container {
                padding: 1rem;
            }
        }

        /* Smooth Scrolling */
        html {
            scroll-behavior: smooth;
        }
    </style>
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-brand">
                <span class="nav-logo">üê¶</span>
                <h1>BirdSound App</h1>
            </div>
            <ul class="nav-links">
                <li><a href="#predict" class="active">Predict</a></li>
                <li><a href="#bulk-upload">Bulk Upload</a></li>
                <li><a href="#retrain">Retrain</a></li>
                <li><a href="#visualizations">Insights</a></li>
                <li><a href="#performance">Performance</a></li>
            </ul>
        </div>
    </nav>

    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>üéµ Bird Sound Classification System</h1>
            <p>MLOps Pipeline - Deep Learning Audio Classification</p>
            <p style="font-size: 1rem; margin-top: 1rem; opacity: 0.9;">African Leadership University | Machine Learning Pipeline Project</p>
        </div>

        <!-- Metrics Dashboard -->
        <div class="metrics-grid">
            <div class="metric-card status-healthy">
                <h3>System Status</h3>
                <div class="value" id="status">üü¢ Healthy</div>
                <div class="label">Model is operational</div>
            </div>
            <div class="metric-card">
                <h3>Model Uptime</h3>
                <div class="value" id="uptime">0h 0m</div>
                <div class="label">Time since deployment</div>
            </div>
            <div class="metric-card">
                <h3>Total Predictions</h3>
                <div class="value" id="total-predictions">0</div>
                <div class="label">Predictions made</div>
            </div>
            <div class="metric-card">
                <h3>Avg Confidence</h3>
                <div class="value" id="avg-confidence">0%</div>
                <div class="label">Model certainty</div>
            </div>
            <div class="metric-card">
                <h3>Model Version</h3>
                <div class="value" id="model-version">v1.0</div>
                <div class="label">Current model</div>
            </div>
            <div class="metric-card">
                <h3>Species Classes</h3>
                <div class="value" id="num-classes">64</div>
                <div class="label">Bird species</div>
            </div>
        </div>

        <!-- Single Audio Prediction Section -->
        <div class="section" id="predict">
            <h2>üé§ Single Audio Prediction</h2>
            <p>Upload a single bird sound file (WAV or MP3) to identify the species</p>
            
            <div class="upload-area" id="single-upload-area">
                <div style="font-size: 4rem; margin-bottom: 1rem;">üéµ</div>
                <h3>Drop your audio file here or click to browse</h3>
                <p style="margin-top: 1rem;">Supported formats: WAV, MP3 | Max 10MB</p>
                <input type="file" id="single-audio-file" accept=".wav,.mp3">
            </div>

            <div style="text-align: center; margin-top: 2rem;">
                <button class="btn btn-primary" id="predict-btn" disabled>üîç Predict Species</button>
            </div>

            <div class="loading" id="predict-loading">
                <div class="spinner"></div>
                <p style="margin-top: 1rem; color: #3b82f6; font-weight: 600; font-size: 1.1rem;">Analyzing audio...</p>
            </div>

            <div class="result-box" id="result-box">
                <h3>üéØ Prediction Results</h3>
                <div style="background: #1e293b; padding: 2rem; border-radius: 12px; margin-bottom: 1.5rem; border: 1px solid #334155;">
                    <h4 style="color: #60a5fa; margin-bottom: 1rem; font-size: 1.1rem;">Predicted Species:</h4>
                    <div style="font-size: 2rem; font-weight: 700; color: #10b981;" id="predicted-species">-</div>
                    <div style="margin-top: 1rem;">
                        <span style="color: #94a3b8;">Confidence:</span>
                        <span style="font-weight: 700; color: #3b82f6; font-size: 1.5rem;" id="confidence-score">0%</span>
                    </div>
                </div>
                <h4 style="color: #60a5fa; margin-bottom: 1rem; font-size: 1.1rem;">Top 5 Predictions:</h4>
                <div id="top-predictions"></div>
            </div>

            <div class="error-box" id="error-box"></div>
        </div>

        <!-- Bulk Upload Section -->
        <div class="section" id="bulk-upload">
            <h2>üì¶ Bulk Upload for Retraining</h2>
            <p>Upload multiple audio files to retrain the model with new data</p>
            
            <div class="info-box">
                <h4>üìù File Naming Convention</h4>
                <p>Name your files as: <code>SpeciesName_identifier.wav</code><br>
                Example: <code>Andean_Tinamou_001.wav</code>, <code>Chilean_Tinamou_002.mp3</code></p>
            </div>

            <div class="upload-area" id="bulk-upload-area">
                <div style="font-size: 4rem; margin-bottom: 1rem;">üìÅ</div>
                <h3>Drop multiple audio files here or click to browse</h3>
                <p style="margin-top: 1rem;">Select multiple WAV/MP3 files | Minimum 10 files required</p>
                <input type="file" id="bulk-audio-files" accept=".wav,.mp3" multiple>
            </div>

            <div class="file-list" id="file-list"></div>

            <div style="text-align: center; margin-top: 2rem;">
                <button class="btn btn-secondary" id="upload-bulk-btn" disabled>üì§ Upload Files</button>
                <button class="btn btn-danger" id="clear-files-btn" disabled>üóëÔ∏è Clear All</button>
            </div>

            <div class="loading" id="upload-loading">
                <div class="spinner"></div>
                <p style="margin-top: 1rem; color: #3b82f6; font-weight: 600; font-size: 1.1rem;">Uploading files...</p>
            </div>

            <div class="progress-bar" id="upload-progress-bar">
                <div class="progress-fill" id="upload-progress-fill">0%</div>
            </div>

            <div class="result-box" id="upload-result-box">
                <h3>‚úÖ Upload Complete</h3>
                <p id="upload-message"></p>
            </div>
        </div>

        <!-- Model Retraining Section -->
        <div class="section" id="retrain">
            <h2>üîÑ Model Retraining</h2>
            <p>Trigger model retraining with uploaded data</p>
            
            <div class="info-box">
                <h4>‚ÑπÔ∏è Retraining Process</h4>
                <p>‚Ä¢ Requires minimum 10 audio files<br>
                ‚Ä¢ Process takes 5-15 minutes depending on data size<br>
                ‚Ä¢ Model will be automatically updated upon completion<br>
                ‚Ä¢ Old model is backed up before retraining</p>
            </div>

            <div style="text-align: center; margin: 2rem 0;">
                <button class="btn btn-primary" id="trigger-retrain-btn">üîÑ Trigger Retraining</button>
                <button class="btn btn-secondary" id="check-retrain-status-btn">üìä Check Status</button>
            </div>

            <div class="retrain-status" id="retrain-status">
                <h3 style="margin-bottom: 1.5rem;">‚öôÔ∏è Retraining in Progress...</h3>
                <div class="progress-bar" style="display: block;">
                    <div class="progress-fill" id="retrain-progress-fill">0%</div>
                </div>
                <p id="retrain-message" style="margin-top: 1.5rem; color: #fde68a;"></p>
            </div>

            <div class="result-box" id="retrain-result-box">
                <h3>‚úÖ Retraining Complete</h3>
                <div id="retrain-results"></div>
            </div>
        </div>

        <!-- Data Visualizations Section -->
        <div class="section" id="visualizations">
            <h2>üìä Data Visualizations & Insights</h2>
            <p>Explore patterns and insights from the bird sound dataset</p>
            
            <div class="info-box">
                <h4>üîç Feature Analysis</h4>
                <p>These visualizations show key acoustic features extracted from bird sounds. Understanding these patterns helps interpret model predictions and dataset characteristics.</p>
            </div>

            <div class="visualization-grid">
                <div>
                    <h3 style="color: #60a5fa; margin-bottom: 1.5rem; font-size: 1.3rem;">üéµ MFCC (Mel-Frequency Cepstral Coefficients)</h3>
                    <div class="chart-container">
                        <canvas id="mfcc-chart"></canvas>
                    </div>
                    <div class="info-box" style="margin-top: 1.5rem;">
                        <p><strong>What it means:</strong> MFCC represents the spectral envelope of sound. Higher values indicate more complex frequency patterns in bird calls.</p>
                        <p style="margin-top: 0.5rem;"><strong>Insight:</strong> Different species show distinct MFCC signatures, helping the model distinguish between calls.</p>
                    </div>
                </div>

                <div>
                    <h3 style="color: #60a5fa; margin-bottom: 1.5rem; font-size: 1.3rem;">üîä Spectral Centroid</h3>
                    <div class="chart-container">
                        <canvas id="spectral-chart"></canvas>
                    </div>
                    <div class="info-box" style="margin-top: 1.5rem;">
                        <p><strong>What it means:</strong> Indicates the "brightness" of sound - where the center of the frequency spectrum lies.</p>
                        <p style="margin-top: 0.5rem;"><strong>Insight:</strong> Higher values suggest brighter, higher-pitched calls. Useful for separating species with different vocal ranges.</p>
                    </div>
                </div>

                <div>
                    <h3 style="color: #60a5fa; margin-bottom: 1.5rem; font-size: 1.3rem;">üìà Zero Crossing Rate (ZCR)</h3>
                    <div class="chart-container">
                        <canvas id="zcr-chart"></canvas>
                    </div>
                    <div class="info-box" style="margin-top: 1.5rem;">
                        <p><strong>What it means:</strong> Measures how often the audio signal changes from positive to negative. Reflects noisiness and texture.</p>
                        <p style="margin-top: 0.5rem;"><strong>Insight:</strong> Higher ZCR indicates more complex, noisy calls. Lower values suggest pure tones or melodic sounds.</p>
                    </div>
                </div>
            </div>

            <div style="text-align: center; margin-top: 2rem;">
                <button class="btn btn-primary" id="load-visualizations-btn">üìä Load Visualizations</button>
            </div>
        </div>

        <!-- Model Performance Section -->
        <div class="section" id="performance">
            <h2>üìà Model Performance Metrics</h2>
            <div class="visualization-grid">
                <div>
                    <h3 style="color: #60a5fa; margin-bottom: 1.5rem; font-size: 1.3rem;">Species Distribution</h3>
                    <div class="chart-container">
                        <canvas id="species-chart"></canvas>
                    </div>
                </div>

                <div>
                    <h3 style="color: #60a5fa; margin-bottom: 1.5rem; font-size: 1.3rem;">Confidence Trend</h3>
                    <div class="chart-container">
                        <canvas id="confidence-chart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="footer">
            <p>&copy; 2024 Bird Sound Classification System | African Leadership University</p>
            <p>Powered by TensorFlow & Flask</p>
        </div>
    </div>

    <script>
        let selectedFile = null;
        let bulkFiles = [];
        let speciesChart = null;
        let confidenceChart = null;
        let mfccChart = null;
        let spectralChart = null;
        let zcrChart = null;

        // Smooth scroll for navigation
        document.querySelectorAll('.nav-links a').forEach(link => {
link.addEventListener('click', function(e) {
e.preventDefault();
const targetId = this.getAttribute('href');
const targetSection = document.querySelector(targetId);
if (targetSection) {
targetSection.scrollIntoView({ behavior: 'smooth' });
// Update active link
                document.querySelectorAll('.nav-links a').forEach(l => l.classList.remove('active'));
                this.classList.add('active');
            }
        });
    });

    function updateMetrics() {
        fetch('/api/health')
            .then(res => res.json())
            .then(data => {
                document.getElementById('status').textContent = data.status === 'healthy' ? 'üü¢ Healthy' : 'üî¥ Unhealthy';
                const hours = Math.floor(data.uptime_seconds / 3600);
                const minutes = Math.floor((data.uptime_seconds % 3600) / 60);
                document.getElementById('uptime').textContent = `${hours}h ${minutes}m`;
                document.getElementById('model-version').textContent = data.model_version;
            })
            .catch(err => console.error('Error fetching health:', err));

        fetch('/api/metrics')
            .then(res => res.json())
            .then(data => {
                document.getElementById('total-predictions').textContent = data.total_predictions;
                document.getElementById('avg-confidence').textContent = (data.avg_confidence * 100).toFixed(1) + '%';
            })
            .catch(err => console.error('Error fetching metrics:', err));

        fetch('/api/classes')
            .then(res => res.json())
            .then(data => {
                document.getElementById('num-classes').textContent = data.num_classes;
            })
            .catch(err => console.error('Error fetching classes:', err));
    }

    const singleUploadArea = document.getElementById('single-upload-area');
    const singleFileInput = document.getElementById('single-audio-file');
    const predictBtn = document.getElementById('predict-btn');

    singleUploadArea.addEventListener('click', () => singleFileInput.click());

    singleUploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        singleUploadArea.classList.add('dragover');
    });

    singleUploadArea.addEventListener('dragleave', () => {
        singleUploadArea.classList.remove('dragover');
    });

    singleUploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        singleUploadArea.classList.remove('dragover');
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            singleFileInput.files = files;
            handleSingleFileSelect();
        }
    });

    singleFileInput.addEventListener('change', handleSingleFileSelect);

    function handleSingleFileSelect() {
        const file = singleFileInput.files[0];
        if (file) {
            selectedFile = file;
            singleUploadArea.querySelector('h3').textContent = `Selected: ${file.name}`;
            predictBtn.disabled = false;
        }
    }

    predictBtn.addEventListener('click', async () => {
        if (!selectedFile) return;

        document.getElementById('predict-loading').style.display = 'block';
        document.getElementById('result-box').style.display = 'none';
        document.getElementById('error-box').style.display = 'none';

        const formData = new FormData();
        formData.append('audio', selectedFile);

        try {
            const response = await fetch('/api/predict', {
                method: 'POST',
                body: formData
            });

            const data = await response.json();

            if (response.ok) {
                document.getElementById('predicted-species').textContent = data.predicted_species;
                document.getElementById('confidence-score').textContent = data.confidence_percent;

                const topPredictionsDiv = document.getElementById('top-predictions');
                topPredictionsDiv.innerHTML = '';

                for (const [species, confidence] of Object.entries(data.top_5_predictions)) {
                    const item = document.createElement('div');
                    item.className = 'result-item';
                    item.innerHTML = `
                        <span style="font-weight: 600; color: #e2e8f0;">${species}</span>
                        <div class="confidence-bar">
                            <div class="confidence-fill" style="width: ${confidence * 100}%"></div>
                        </div>
                        <span style="font-weight: 600; color: #3b82f6;">${(confidence * 100).toFixed(2)}%</span>
                    `;
                    topPredictionsDiv.appendChild(item);
                }

                document.getElementById('result-box').style.display = 'block';
                updateMetrics();
                updateCharts();
            } else {
                document.getElementById('error-box').textContent = data.error || 'Prediction failed';
                document.getElementById('error-box').style.display = 'block';
            }
        } catch (error) {
            document.getElementById('error-box').textContent = 'Network error: ' + error.message;
            document.getElementById('error-box').style.display = 'block';
        } finally {
            document.getElementById('predict-loading').style.display = 'none';
        }
    });

    const bulkUploadArea = document.getElementById('bulk-upload-area');
    const bulkFileInput = document.getElementById('bulk-audio-files');
    const fileListDiv = document.getElementById('file-list');
    const uploadBulkBtn = document.getElementById('upload-bulk-btn');
    const clearFilesBtn = document.getElementById('clear-files-btn');

    bulkUploadArea.addEventListener('click', () => bulkFileInput.click());

    bulkUploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        bulkUploadArea.classList.add('dragover');
    });

    bulkUploadArea.addEventListener('dragleave', () => {
        bulkUploadArea.classList.remove('dragover');
    });

    bulkUploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        bulkUploadArea.classList.remove('dragover');
        const files = Array.from(e.dataTransfer.files);
        addBulkFiles(files);
    });

    bulkFileInput.addEventListener('change', (e) => {
        const files = Array.from(e.target.files);
        addBulkFiles(files);
    });

    function addBulkFiles(files) {
        bulkFiles = bulkFiles.concat(files);
        updateFileList();
    }

    function updateFileList() {
        fileListDiv.innerHTML = '';
        bulkFiles.forEach((file, index) => {
            const fileItem = document.createElement('div');
            fileItem.className = 'file-item';
            fileItem.innerHTML = `
                <span style="color: #cbd5e1;">${file.name} (${(file.size / 1024).toFixed(2)} KB)</span>
                <button class="remove-btn" onclick="removeFile(${index})">Remove</button>
            `;
            fileListDiv.appendChild(fileItem);
        });

        uploadBulkBtn.disabled = bulkFiles.length === 0;
        clearFilesBtn.disabled = bulkFiles.length === 0;
    }

    function removeFile(index) {
        bulkFiles.splice(index, 1);
        updateFileList();
    }

    clearFilesBtn.addEventListener('click', () => {
        bulkFiles = [];
        updateFileList();
    });

    uploadBulkBtn.addEventListener('click', async () => {
        if (bulkFiles.length === 0) return;

        document.getElementById('upload-loading').style.display = 'block';
        document.getElementById('upload-progress-bar').style.display = 'block';
        document.getElementById('upload-result-box').style.display = 'none';

        const formData = new FormData();
        bulkFiles.forEach(file => formData.append('files', file));

        try {
            const response = await fetch('/api/upload_bulk', {
                method: 'POST',
                body: formData
            });

            const data = await response.json();

            if (response.ok) {
                document.getElementById('upload-message').textContent = data.message;
                document.getElementById('upload-result-box').style.display = 'block';
                bulkFiles = [];
                updateFileList();
            } else {
                alert('Upload failed: ' + data.error);
            }
        } catch (error) {
            alert('Network error: ' + error.message);
        } finally {
            document.getElementById('upload-loading').style.display = 'none';
            document.getElementById('upload-progress-bar').style.display = 'none';
        }
    });

    document.getElementById('trigger-retrain-btn').addEventListener('click', async () => {
        if (!confirm('Are you sure you want to trigger retraining? This will take several minutes.')) return;

        try {
            const response = await fetch('/api/trigger_retrain', { method: 'POST' });
            const data = await response.json();

            if (response.ok) {
                document.getElementById('retrain-status').style.display = 'block';
                document.getElementById('retrain-message').textContent = data.message;
                monitorRetraining();
            } else {
                alert('Retraining failed: ' + data.error);
            }
        } catch (error) {
            alert('Network error: ' + error.message);
        }
    });

    document.getElementById('check-retrain-status-btn').addEventListener('click', checkRetrainStatus);

    async function checkRetrainStatus() {
        try {
            const response = await fetch('/api/retrain_status');
            const data = await response.json();

            if (data.is_retraining) {
                document.getElementById('retrain-status').style.display = 'block';
                document.getElementById('retrain-progress-fill').style.width = data.progress + '%';
                document.getElementById('retrain-progress-fill').textContent = data.progress + '%';
            } else if (data.progress === 100) {
                document.getElementById('retrain-status').style.display = 'none';
                document.getElementById('retrain-result-box').style.display = 'block';
                const resultsDiv = document.getElementById('retrain-results');
                resultsDiv.innerHTML = `
                    <p style="color: #cbd5e1;"><strong>Model Version:</strong> ${data.model_version}</p>
                    <p style="color: #cbd5e1;"><strong>Last Retrain:</strong> ${new Date(data.last_retrain).toLocaleString()}</p>
                `;
                updateMetrics();
            } else {
                alert('No retraining in progress');
            }
        } catch (error) {
            console.error('Error checking retrain status:', error);
        }
    }

    function monitorRetraining() {
        const interval = setInterval(async () => {
            const response = await fetch('/api/retrain_status');
            const data = await response.json();

            if (data.is_retraining) {
                document.getElementById('retrain-progress-fill').style.width = data.progress + '%';
                document.getElementById('retrain-progress-fill').textContent = data.progress + '%';
            } else {
                clearInterval(interval);
                if (data.progress === 100) {
                    document.getElementById('retrain-status').style.display = 'none';
                    document.getElementById('retrain-result-box').style.display = 'block';
                    document.getElementById('retrain-results').innerHTML = `
                        <p style="color: #cbd5e1;"><strong>‚úÖ Retraining successful!</strong></p>
                        <p style="color: #cbd5e1;"><strong>Model Version:</strong> ${data.model_version}</p>
                        <p style="color: #cbd5e1;"><strong>Completed:</strong> ${new Date(data.last_retrain).toLocaleString()}</p>
                    `;
                    updateMetrics();
                } else {
                    document.getElementById('retrain-message').textContent = 'Retraining failed. Check server logs.';
                }
            }
        }, 3000);
    }

    document.getElementById('load-visualizations-btn').addEventListener('click', loadFeatureVisualizations);

    async function loadFeatureVisualizations() {
        try {
            const response = await fetch('/api/feature_analysis');
            const data = await response.json();

            if (data.error) {
                alert(data.error);
                return;
            }

            if (mfccChart) mfccChart.destroy();
            if (spectralChart) spectralChart.destroy();
            if (zcrChart) zcrChart.destroy();

            const chartOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { 
                        display: true,
                        labels: {
                            color: '#cbd5e1'
                        }
                    },
                    title: {
                        display: true,
                        color: '#94a3b8',
                        font: {
                            size: 14
                        }
                    }
                },
                scales: {
                    x: {
                        ticks: {
                            color: '#94a3b8'
                        },
                        grid: {
                            color: '#334155'
                        }
                    },
                    y: {
                        ticks: {
                            color: '#94a3b8'
                        },
                        grid: {
                            color: '#334155'
                        }
                    }
                }
            };

            const mfccCtx = document.getElementById('mfcc-chart').getContext('2d');
            mfccChart = new Chart(mfccCtx, {
                type: 'bar',
                data: {
                    labels: data.mfcc_analysis.labels,
                    datasets: [{
                        label: 'MFCC Mean',
                        data: data.mfcc_analysis.values,
                        backgroundColor: 'rgba(59, 130, 246, 0.6)',
                        borderColor: 'rgba(59, 130, 246, 1)',
                        borderWidth: 2
                    }]
                },
                options: {
                    ...chartOptions,
                    plugins: {
                        ...chartOptions.plugins,
                        title: {
                            ...chartOptions.plugins.title,
                            text: data.mfcc_analysis.interpretation
                        }
                    }
                }
            });

            const spectralCtx = document.getElementById('spectral-chart').getContext('2d');
            spectralChart = new Chart(spectralCtx, {
                type: 'line',
                data: {
                    labels: data.spectral_centroid.labels,
                    datasets: [{
                        label: 'Spectral Centroid (Hz)',
                        data: data.spectral_centroid.values,
                        backgroundColor: 'rgba(16, 185, 129, 0.2)',
                        borderColor: 'rgba(16, 185, 129, 1)',
                        borderWidth: 2,
                        fill: true
                    }]
                },
                options: {
                    ...chartOptions,
                    plugins: {
                        ...chartOptions.plugins,
                        title: {
                            ...chartOptions.plugins.title,
                            text: data.spectral_centroid.interpretation
                        }
                    }
                }
            });

            const zcrCtx = document.getElementById('zcr-chart').getContext('2d');
            zcrChart = new Chart(zcrCtx, {
                type: 'bar',
                data: {
                    labels: data.zcr_analysis.labels,
                    datasets: [{
                        label: 'Zero Crossing Rate',
                        data: data.zcr_analysis.values,
                        backgroundColor: 'rgba(139, 92, 246, 0.6)',
                        borderColor: 'rgba(139, 92, 246, 1)',
                        borderWidth: 2
                    }]
                },
                options: {
                    ...chartOptions,
                    plugins: {
                        ...chartOptions.plugins,
                        title: {
                            ...chartOptions.plugins.title,
                            text: data.zcr_analysis.interpretation
                        }
                    }
                }
            });
        } catch (error) {
            alert('Failed to load visualizations: ' + error.message);
        }
    }

    async function updateCharts() {
        try {
            const metricsRes = await fetch('/api/metrics');
            const metricsData = await metricsRes.json();

            const speciesData = metricsData.species_distribution || {};
            const speciesLabels = Object.keys(speciesData).slice(0, 10);
            const speciesCounts = Object.values(speciesData).slice(0, 10);

            if (speciesChart) speciesChart.destroy();

            const speciesCtx = document.getElementById('species-chart').getContext('2d');
            speciesChart = new Chart(speciesCtx, {
                type: 'bar',
                data: {
                    labels: speciesLabels,
                    datasets: [{
                        label: 'Prediction Count',
                        data: speciesCounts,
                        backgroundColor: 'rgba(59, 130, 246, 0.6)',
                        borderColor: 'rgba(59, 130, 246, 1)',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { 
                            display: false 
                        }
                    },
                    scales: {
                        x: {
                            ticks: {
                                color: '#94a3b8'
                            },
                            grid: {
                                color: '#334155'
                            }
                        },
                        y: {
                            ticks: {
                                color: '#94a3b8'
                            },
                            grid: {
                                color: '#334155'
                            }
                        }
                    }
                }
            });

            const recentPredictions = metricsData.recent_predictions || [];
            const confidenceLabels = recentPredictions.map((p, i) => `#${i + 1}`);
            const confidenceValues = recentPredictions.map(p => p.confidence * 100);

            if (confidenceChart) confidenceChart.destroy();

            const confidenceCtx = document.getElementById('confidence-chart').getContext('2d');
            confidenceChart = new Chart(confidenceCtx, {
                type: 'line',
                data: {
                    labels: confidenceLabels,
                    datasets: [{
                        label: 'Confidence %',
                        data: confidenceValues,
                        backgroundColor: 'rgba(16, 185, 129, 0.2)',
                        borderColor: 'rgba(16, 185, 129, 1)',
                        borderWidth: 2,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            ticks: {
                                color: '#94a3b8'
                            },
                            grid: {
                                color: '#334155'
                            }
                        },
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                color: '#94a3b8'
                            },
                            grid: {
                                color: '#334155'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            labels: {
                                color: '#cbd5e1'
                            }
                        }
                    }
                }
            });
        } catch (error) {
            console.error('Error updating charts:', error);
        }
    }

    updateMetrics();
    setInterval(updateMetrics, 10000);
    updateCharts();
</script>